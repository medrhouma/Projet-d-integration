// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Énumération pour les rôles
enum Role {
  Etudiant
  Enseignant
  ChefDepartement
  Admin
}

// Énumération pour le statut d'absence
enum StatutAbsence {
  Justifiee    @map("Justifiée")
  NonJustifiee @map("Non justifiée")
}

// Table principale d'authentification
model Utilisateur {
  id_utilisateur    Int      @id @default(autoincrement())
  nom               String   @db.VarChar(100)
  prenom            String   @map("prénom") @db.VarChar(100)
  email             String   @unique @db.VarChar(255)
  identifiant       String   @unique @db.VarChar(50)
  mot_de_passe_hash String   @db.VarChar(255)
  role              Role     @map("rôle")
  date_creation     DateTime @default(now())
  date_modification DateTime @updatedAt

  // Relations
  etudiant          Etudiant?
  enseignant        Enseignant?
  messages_envoyes  Message[] @relation("Expediteur")
  messages_recus    Message[] @relation("Destinataire")
  // Événements organisés par cet utilisateur
  evenements_organises EvenementInstitutionnel[]
  // Rattrapages planifiés par cet utilisateur
  rattrapages_planificateur Rattrapage[] @relation("RattrapagePlanificateur")
  // Ajustements créés par cet utilisateur
  ajustements_auteur AjustementEmploiTemps[]

  @@map("utilisateur")
}

// Messages entre utilisateurs
model Message {
  id_message      Int       @id @default(autoincrement())
  sujet           String?   @db.VarChar(255)
  contenu         String?   @db.Text
  date_creation   DateTime  @default(now())
  id_expediteur   Int
  id_destinataire Int
  lu              Boolean   @default(false)

  expediteur      Utilisateur @relation("Expediteur", fields: [id_expediteur], references: [id_utilisateur], onDelete: Cascade)
  destinataire    Utilisateur @relation("Destinataire", fields: [id_destinataire], references: [id_utilisateur], onDelete: Cascade)

  @@index([id_expediteur])
  @@index([id_destinataire])
  @@map("message")
}

// Table Département
model Departement {
  id_departement Int    @id @default(autoincrement())
  nom            String @unique @db.VarChar(100)

  // Relations
  specialites Specialite[]
  enseignants Enseignant[]

  @@map("departement")
}

// Table Spécialité
model Specialite {
  id_specialite  Int @id @default(autoincrement())
  nom            String @unique @db.VarChar(100)
  id_departement Int

  // Relations
  departement Departement @relation(fields: [id_departement], references: [id_departement], onDelete: Cascade)
  niveaux     Niveau[]
  etudiants   Etudiant[]

  @@map("specialite")
}

// Table Niveau
model Niveau {
  id_niveau     Int    @id @default(autoincrement())
  nom           String @db.VarChar(50)
  id_specialite Int

  // Relations
  specialite Specialite @relation(fields: [id_specialite], references: [id_specialite], onDelete: Cascade)
  groupes    Groupe[]
  matieres   Matiere[]
  etudiants  Etudiant[]  // Ajout de la relation

  @@map("niveau")
}

// Table Groupe
model Groupe {
  id_groupe Int    @id @default(autoincrement())
  nom       String @db.VarChar(50)
  id_niveau Int

  // Relations
  niveau       Niveau        @relation(fields: [id_niveau], references: [id_niveau], onDelete: Cascade)
  etudiants    Etudiant[]
  emploi_temps EmploiTemps[]
  // Rattrapages liant ce groupe
  rattrapage_groupes RattrapageGroupe[]

  @@map("groupe")
}

// Table Étudiant - MODIFIÉE
model Etudiant {
  id_etudiant        Int     @id
  numero_inscription String  @unique @db.Char(6)
  id_specialite      Int?    // Gardé pour la relation
  id_niveau          Int?    // AJOUT
  id_groupe          Int?    // Gardé pour la relation
  
  // NOUVEAUX CHAMPS pour affichage direct
  departement        String? @db.VarChar(100)
  specialite_nom     String? @db.VarChar(100)
  niveau_nom         String? @db.VarChar(50)
  groupe_nom         String? @db.VarChar(50)

  // Relations
  utilisateur Utilisateur @relation(fields: [id_etudiant], references: [id_utilisateur], onDelete: Cascade)
  specialite  Specialite?  @relation(fields: [id_specialite], references: [id_specialite])
  niveau      Niveau?      @relation(fields: [id_niveau], references: [id_niveau])  // AJOUT
  groupe      Groupe?      @relation(fields: [id_groupe], references: [id_groupe])
  absences    Absence[]

  @@index([id_specialite])
  @@index([id_niveau])  // AJOUT
  @@index([id_groupe])
  @@map("etudiant")
}

// Table Enseignant - MODIFIÉE
model Enseignant {
  id_enseignant       Int     @id
  matricule           String  @unique @db.VarChar(50)
  id_departement      Int?    // Gardé pour la relation
  est_chef_departement Boolean @default(false) // Indique si l'enseignant est chef de département
  
  // NOUVEAU CHAMP pour affichage direct
  departement_nom     String? @db.VarChar(100)

  // Relations
  utilisateur      Utilisateur         @relation(fields: [id_enseignant], references: [id_utilisateur], onDelete: Cascade)
  departement      Departement?        @relation(fields: [id_departement], references: [id_departement])
  matieres         Matiere[]
  emploi_temps     EmploiTemps[]
  absences         AbsenceEnseignant[]
  // Rattrapages où cet enseignant intervient
  rattrapages Rattrapage[]

  @@index([id_departement])
  @@map("enseignant")
}

// Table Matière
model Matiere {
  id_matiere    Int @id @default(autoincrement())
  nom           String @db.VarChar(100)
  id_niveau     Int
  id_enseignant Int

  // Relations
  niveau       Niveau        @relation(fields: [id_niveau], references: [id_niveau], onDelete: Cascade)
  enseignant   Enseignant    @relation(fields: [id_enseignant], references: [id_enseignant])
  emploi_temps EmploiTemps[]
  // Rattrapages liés à cette matière
  rattrapages Rattrapage[]

  @@map("matiere")
}

// Table Salle
model Salle {
  id_salle Int    @id @default(autoincrement())
  code     String @unique @db.VarChar(20)
  type     String @db.VarChar(50)
  capacite Int    @map("capacité")

  // Relations
  emploi_temps EmploiTemps[]
  // Rattrapages dans cette salle
  rattrapages Rattrapage[]

  @@map("salle")
}

// Table Emploi du Temps
model EmploiTemps {
  id_emploi     Int      @id @default(autoincrement())
  date          DateTime @db.Date
  heure_debut   DateTime @db.Time
  heure_fin     DateTime @db.Time
  id_salle      Int
  id_matiere    Int
  id_groupe     Int
  id_enseignant Int

  // Relations
  salle      Salle      @relation(fields: [id_salle], references: [id_salle])
  matiere    Matiere    @relation(fields: [id_matiere], references: [id_matiere])
  groupe     Groupe     @relation(fields: [id_groupe], references: [id_groupe])
  enseignant Enseignant @relation(fields: [id_enseignant], references: [id_enseignant])
  absences   Absence[]
  // Rattrapages liés si cet emploi a été annulé
  rattrapages_annules Rattrapage[] @relation("RattrapageEmploiAnnule")
  // Ajustements originaires pour cet emploi
  ajustements_origine AjustementEmploiTemps[] @relation("AjustementEmploiOrigine")

  @@index([date])
  @@index([id_groupe, date])
  @@map("emploi_temps")
}

// Table Absence
model Absence {
  id_absence  Int           @id @default(autoincrement())
  id_etudiant Int
  id_emploi   Int
  motif       String?       @db.VarChar(255)
  statut      StatutAbsence

  // Relations
  etudiant     Etudiant    @relation(fields: [id_etudiant], references: [id_etudiant], onDelete: Cascade)
  emploi_temps EmploiTemps @relation(fields: [id_emploi], references: [id_emploi], onDelete: Cascade)

  @@index([id_etudiant])
  @@index([id_emploi])
  @@map("absence")
}

// Table Absence Enseignant
model AbsenceEnseignant {
  id_absence     Int           @id @default(autoincrement())
  id_enseignant  Int
  id_emploi      Int
  motif          String?       @db.VarChar(255)
  statut         StatutAbsence
  date_creation  DateTime      @default(now())

  // Relations
  enseignant   Enseignant @relation(fields: [id_enseignant], references: [id_enseignant], onDelete: Cascade)
  

  @@map("absence_enseignant")
}

// Table Événement Institutionnel
model EvenementInstitutionnel {
  id_evenement     Int       @id @default(autoincrement())
  titre            String    @db.VarChar(255)
  description      String?   @db.Text
  date_debut       DateTime  @db.DateTime
  date_fin         DateTime  @db.DateTime
  type             String    @db.VarChar(50) // 'fermeture', 'conference', 'autre'
  id_organisateur  Int
  concerne_tous    Boolean   @default(false)
  concerne_departements Json? // Liste des IDs de départements concernés (si concerne_tous = false)
  date_creation    DateTime  @default(now())
  date_modification DateTime @updatedAt

  // Relations
  organisateur Utilisateur @relation(fields: [id_organisateur], references: [id_utilisateur])
  rattrapages  Rattrapage[]

  @@index([date_debut])
  @@index([date_fin])
  @@index([type])
  @@map("evenement_institutionnel")
}

// Table Rattrapage
model Rattrapage {
  id_rattrapage    Int       @id @default(autoincrement())
  id_evenement     Int?      // Lien vers l'événement annulé (si applicable)
  id_emploi_annule Int?      // Lien vers le cours annulé (si applicable)
  id_matiere       Int
  id_enseignant    Int
  id_salle         Int
  date             DateTime  @db.Date
  heure_debut      DateTime  @db.Time
  heure_fin        DateTime  @db.Time
  motif            String    @db.VarChar(255)
  statut           String    @db.VarChar(20) @default("planifie") // planifié, effectué, annulé
  id_planificateur Int
  date_creation    DateTime  @default(now())
  date_modification DateTime @updatedAt

  // Relations
  evenement      EvenementInstitutionnel? @relation(fields: [id_evenement], references: [id_evenement])
  emploi_annule  EmploiTemps?             @relation("RattrapageEmploiAnnule", fields: [id_emploi_annule], references: [id_emploi])
  matiere        Matiere                  @relation(fields: [id_matiere], references: [id_matiere])
  enseignant     Enseignant               @relation(fields: [id_enseignant], references: [id_enseignant])
  salle          Salle                    @relation(fields: [id_salle], references: [id_salle])
  planificateur  Utilisateur              @relation("RattrapagePlanificateur", fields: [id_planificateur], references: [id_utilisateur])
  groupes        RattrapageGroupe[]
  ajustements    AjustementEmploiTemps[]

  @@index([date])
  @@index([id_matiere])
  @@index([id_enseignant])
  @@map("rattrapage")
}

// Table de liaison entre Rattrapage et Groupe
model RattrapageGroupe {
  id_rattrapage_groupe Int      @id @default(autoincrement())
  id_rattrapage       Int
  id_groupe           Int

  // Relations
  rattrapage Rattrapage @relation(fields: [id_rattrapage], references: [id_rattrapage], onDelete: Cascade)
  groupe     Groupe     @relation(fields: [id_groupe], references: [id_groupe])

  @@unique([id_rattrapage, id_groupe])
  @@map("rattrapage_groupe")
}

// Table Ajustement d'Emploi du Temps
model AjustementEmploiTemps {
  id_ajustement    Int       @id @default(autoincrement())
  id_emploi_origine Int      // L'ID de l'emploi du temps d'origine
  id_rattrapage    Int?      // Lien vers le rattrapage (si applicable)
  type_ajustement  String    @db.VarChar(50) // 'annulation', 'deplacement', 'changement_salle', 'autre'
  anciennes_valeurs Json?    // Anciennes valeurs (pour annulation)
  nouvelles_valeurs Json?    // Nouvelles valeurs (si modification)
  motif            String    @db.VarChar(255)
  id_auteur        Int
  date_creation    DateTime  @default(now())

  // Relations
  rattrapage   Rattrapage? @relation(fields: [id_rattrapage], references: [id_rattrapage])
  auteur       Utilisateur @relation(fields: [id_auteur], references: [id_utilisateur])
  emploi_origine EmploiTemps @relation("AjustementEmploiOrigine", fields: [id_emploi_origine], references: [id_emploi])

  @@index([id_emploi_origine])
  @@index([id_rattrapage])
  @@index([date_creation])
  @@map("ajustement_emploi_temps")
}
